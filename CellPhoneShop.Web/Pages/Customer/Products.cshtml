@page
@model CellPhoneShop.Web.Pages.Customer.ProductsModel
@{
    ViewData["Title"] = "Products - OData Demo";
    Layout = "~/Pages/Shared/_CustomerLayout.cshtml";
}

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header pb-0">
                    <div class="d-lg-flex">
                        <div>
                            <h5 class="mb-0">Phone Variants - OData Demo</h5>
                            <p class="text-sm mb-0">
                                Advanced filtering and querying with OData
                            </p>
                        </div>
                        <div class="ms-auto my-auto mt-lg-0 mt-4">
                            <div class="ms-auto my-auto">
                                <button type="button" class="btn btn-outline-primary btn-sm mb-0" onclick="loadAvailableVariants()">
                                    Available Only
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm mb-0" onclick="loadDiscountedVariants()">
                                    Discounted
                                </button>
                                <button type="button" class="btn btn-outline-info btn-sm mb-0" onclick="loadAllVariants()">
                                    All Variants
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filter Section -->
                <div class="card-body px-0 pb-0">
                    <div class="row px-4 mb-3">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-control-label">Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Phone name, brand, color...">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-control-label">Min Price</label>
                                <input type="number" class="form-control" id="minPrice" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-control-label">Max Price</label>
                                <input type="number" class="form-control" id="maxPrice" placeholder="50000000">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-control-label">Brand</label>
                                <select class="form-control" id="brandFilter">
                                    <option value="">All Brands</option>
                                    @foreach(var brand in Model.Brands)
                                    {
                                        <option value="@brand.BrandId">@brand.BrandName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label class="form-control-label">Sort By</label>
                                <select class="form-control" id="sortBy">
                                    <option value="Price asc">Price (Low to High)</option>
                                    <option value="Price desc">Price (High to Low)</option>
                                    <option value="PhoneName asc">Name (A-Z)</option>
                                    <option value="PhoneName desc">Name (Z-A)</option>
                                    <option value="BrandName asc">Brand (A-Z)</option>
                                    <option value="Stock desc">Stock (High to Low)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-primary btn-sm" onclick="applyFilters()">
                                Search
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div class="table-responsive">
                    <table class="table table-flush" id="products-list">
                        <thead class="thead-light">
                            <tr>
                                <th>Image</th>
                                <th>Product</th>
                                <th>Brand</th>
                                <th>Color</th>
                                <th>Price</th>
                                <th>Discount</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-tbody">
                            <!-- Data will be loaded via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading indicator -->
                <div class="text-center py-4" id="loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="border-top py-3 px-3 d-flex align-items-center">
                    <p class="font-weight-semibold ms-auto mb-0" id="results-info">
                        <!-- Results info will be shown here -->
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentData = [];
        
        // Load all variants on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllVariants();
        });
        
        async function loadAllVariants() {
            await loadData('/odata/customer/phonevariants?$top=50&$orderby=Price asc');
        }
        
        async function loadAvailableVariants() {
            await loadData('/odata/customer/phonevariants/available?$top=50&$orderby=Price asc');
        }
        
        async function loadDiscountedVariants() {
            await loadData('/odata/customer/phonevariants/discounted?$top=50&$orderby=Price asc');
        }
        
        async function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value;
            const minPrice = document.getElementById('minPrice').value;
            const maxPrice = document.getElementById('maxPrice').value;
            const brandId = document.getElementById('brandFilter').value;
            const sortBy = document.getElementById('sortBy').value;
            
            // Build OData filter
            const filters = [];
            
            if (searchTerm) {
                filters.push(`(contains(tolower(PhoneName), '${searchTerm.toLowerCase()}') or contains(tolower(BrandName), '${searchTerm.toLowerCase()}') or contains(tolower(ColorName), '${searchTerm.toLowerCase()}'))`);
            }
            
            if (minPrice) {
                filters.push(`Price ge ${minPrice}`);
            }
            
            if (maxPrice) {
                filters.push(`Price le ${maxPrice}`);
            }
            
            if (brandId) {
                filters.push(`BrandId eq ${brandId}`);
            }
            
            let url = '/odata/customer/phonevariants?$top=50';
            
            if (filters.length > 0) {
                url += `&$filter=${encodeURIComponent(filters.join(' and '))}`;
            }
            
            if (sortBy) {
                url += `&$orderby=${encodeURIComponent(sortBy)}`;
            }
            
            await loadData(url);
        }
        
        async function loadData(url) {
            const loading = document.getElementById('loading');
            const tbody = document.getElementById('products-tbody');
            const resultsInfo = document.getElementById('results-info');
            
            try {
                loading.style.display = 'block';
                tbody.innerHTML = '';
                
                console.log('Loading data from:', url);
                
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                
                currentData = data.value || data;
                renderTable(currentData);
                
                resultsInfo.textContent = `Showing ${currentData.length} results`;
                
            } catch (error) {
                console.error('Error loading data:', error);
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error loading data: ${error.message}</td></tr>`;
            } finally {
                loading.style.display = 'none';
            }
        }
        
        function renderTable(data) {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No products found</td></tr>';
                return;
            }
            
            data.forEach(variant => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <img src="${variant.colorImageUrl || '/images/no-image.jpg'}" 
                             alt="${variant.colorName || 'No image'}" 
                             class="avatar avatar-sm me-3" 
                             onerror="this.src='/images/no-image.jpg'">
                    </td>
                    <td>
                        <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-sm">${variant.phoneName}</h6>
                            <p class="text-xs text-secondary mb-0">SKU: ${variant.sku || 'N/A'}</p>
                        </div>
                    </td>
                    <td>
                        <p class="text-xs font-weight-bold mb-0">${variant.brandName}</p>
                    </td>
                    <td>
                        <p class="text-xs font-weight-bold mb-0">${variant.colorName || 'Default'}</p>
                    </td>
                    <td>
                        <div class="d-flex flex-column">
                            <span class="text-sm font-weight-bold">${formatPrice(variant.price)}</span>
                            ${variant.phoneBasePrice > variant.price ? 
                                `<span class="text-xs text-secondary text-decoration-line-through">${formatPrice(variant.phoneBasePrice)}</span>` : ''}
                        </div>
                    </td>
                    <td>
                        ${variant.discountPercentage > 0 ? 
                            `<span class="badge badge-sm bg-gradient-success">${variant.discountPercentage}%</span>` : 
                            '<span class="text-xs">No discount</span>'}
                    </td>
                    <td>
                        <span class="text-xs font-weight-bold ${variant.stock > 0 ? 'text-success' : 'text-danger'}">
                            ${variant.stock}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-sm ${variant.isActive ? 'bg-gradient-success' : 'bg-gradient-secondary'}">
                            ${variant.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-link text-primary text-gradient px-3 mb-0" onclick="viewDetails(${variant.variantId})">
                            <i class="fas fa-eye me-2"></i>View
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }
        
        function viewDetails(variantId) {
            // Redirect to product detail page
            window.location.href = `/Customer/Product/Details/${variantId}`;
        }
    </script>
} 